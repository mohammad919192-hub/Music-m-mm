<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>جنازه — تجربه سه‌بعدی و ویژوالایزر</title>
<meta name="description" content="پلیر پیشرفته با ویژوالایزر، افکت سه‌بعدی، لیریکس و کنترل کامل" />
<style>
  :root{
    --bg1:#071018; --bg2:#0b1020; --card:#0f1624; --muted:#aeb3b8;
    --accent:#18b0ff; --accent2:#8b5cf6; --glass:rgba(255,255,255,0.03);
    --radius:14px; --trans:300ms cubic-bezier(.2,.8,.2,1);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Vazirmatn,Segoe UI,Roboto,Arial,sans-serif;color:#fff;background:linear-gradient(180deg,var(--bg1),var(--bg2));direction:rtl;overflow-x:hidden}
  .wrap{min-height:100vh;padding:28px;display:flex;align-items:center;justify-content:center}
  .stage{width:100%;max-width:1120px;transform-style:preserve-3d;perspective:1200px;}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px;padding:16px;display:grid;grid-template-columns:320px 1fr;gap:18px;align-items:start;box-shadow:0 30px 80px rgba(2,8,20,.7);
    transform-style:preserve-3d;backface-visibility:hidden;position:relative;overflow:visible;
  }

  /* cover 3D container */
  .cover-3d{width:100%;height:100%;display:block;transform-style:preserve-3d;will-change:transform}
  .cover{
    width:100%;border-radius:12px;display:block;object-fit:cover;box-shadow:0 20px 50px rgba(2,8,20,.6);
    transform-origin:center center;transition:transform 350ms ease, box-shadow 350ms ease;
  }
  .cover-reflection{
    position:absolute;left:12px;right:12px;bottom:12px;height:60px;border-radius:10px;filter:blur(30px) saturate(110%);opacity:.12;background-size:cover;background-position:center;z-index:-1;
  }

  /* metadata and controls */
  .meta h1{margin:10px 0 6px;font-size:1.6rem;letter-spacing:.2px}
  .meta p{margin:0;color:var(--muted)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#001;border:0;padding:10px 14px;border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 12px 40px rgba(24,176,255,0.08)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}

  /* viz */
  .viz{grid-column:1/-1;border-radius:12px;overflow:hidden;padding:8px;position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));}
  .canvas-wrap{border-radius:10px;overflow:hidden;padding:8px}
  canvas#viz{width:100%;height:180px;display:block}

  /* 3D depth layers */
  .depth-layer{
    position:absolute;inset:0;border-radius:12px;pointer-events:none;mix-blend-mode:screen;
    background:
      radial-gradient(circle at 20% 10%, rgba(24,176,255,0.06), transparent 10%),
      radial-gradient(circle at 80% 80%, rgba(139,92,246,0.04), transparent 15%);
    z-index:2;
  }

  /* lyrics */
  .lyrics-box{max-height:220px;overflow:auto;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);color:var(--muted);line-height:1.6}
  .lyrics-box .line{padding:6px 0}

  /* 3D hover subtle tilt for desktop */
  @media(min-width:900px){
    .card:hover .cover{transform:translateZ(24px) rotateX(3deg) rotateY(-2deg);box-shadow:0 40px 90px rgba(2,8,20,.75)}
    .card:hover .meta{transform:translateZ(18px)}
  }

  /* responsive */
  @media(max-width:920px){
    .card{grid-template-columns:1fr;padding:14px}
    canvas#viz{height:140px}
  }
  @media(max-width:420px){
    canvas#viz{height:110px}
    .meta h1{font-size:1.2rem}
  }

  /* small helpers */
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:.92rem;color:var(--muted)}
  .pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:.9rem}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <div class="card" id="card">
        <!-- left: cover & controls -->
        <aside style="display:flex;flex-direction:column;gap:12px">
          <div style="position:relative">
            <div class="cover-3d" id="cover3d">
              <img id="cover" class="cover" src="images (2).jpeg" alt="کاور جنازه">
              <div id="coverRef" class="cover-reflection" style="background-image:url('images (2).jpeg')"></div>
            </div>
            <div style="position:absolute;right:12px;top:12px">
              <div class="pill small">حجم: <span id="volLabel">100%</span></div>
            </div>
          </div>

          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <div style="flex:1">
              <button id="playBtn" class="btn">پخش</button>
              <button id="pauseBtn" class="btn ghost hidden">توقف</button>
            </div>
            <div style="text-align:left">
              <button id="downloadBtn" class="btn ghost">دانلود</button>
            </div>
          </div>

          <div>
            <div class="small" style="margin-bottom:6px">لیست آهنگ‌ها</div>
            <div id="playlist" class="row" style="flex-direction:column;align-items:stretch;gap:8px">
              <div class="pill" style="display:flex;align-items:center;gap:8px">
                <div style="width:42px;height:42px;border-radius:8px;background-image:url('images (2).jpeg');background-size:cover"></div>
                <div style="flex:1;text-align:right">
                  <div style="font-weight:700">جنازه</div>
                  <div class="small">هوومن · یانگ سادن</div>
                </div>
              </div>
            </div>
          </div>
        </aside>

        <!-- right: meta, viz, lyrics -->
        <main>
          <div class="meta">
            <h1 id="title">جنازه</h1>
            <p id="desc" class="small">ترک جدید از هوومن و یانگ سادن</p>
          </div>

          <div class="viz" style="margin-top:12px">
            <div class="canvas-wrap" style="position:relative">
              <canvas id="viz"></canvas>
              <div class="depth-layer" id="depthLayer"></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
              <div class="small">ویژوالایزر پیشرفته</div>
              <div class="row">
                <label class="small">شدت</label>
                <input id="sensitivity" type="range" min="1" max="6" step="0.1" value="3" />
              </div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px;align-items:start">
            <div>
              <div class="small" style="margin-bottom:6px">متن آهنگ</div>
              <div id="lyrics" class="lyrics-box">
                <!-- اینجا متن را خودت پیست کن یا لینک منبع را قرار بده -->
                <div class="line">برای اضافه کردن متن: متن را اینجا پیست کن یا روی "بارگیری از وب" کلیک کن تا لینک منبع باز شود.</div>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <button id="pasteLyrics" class="btn ghost">پیست متن اینجا</button>
                <button id="openSource" class="btn ghost">بارگیری از وب</button>
              </div>
            </div>

            <div>
              <div class="small" style="margin-bottom:6px">کنترل‌های پیشرفته</div>
              <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)">
                <div class="small">Bass Boost <input id="bassBoost" type="checkbox" style="margin-right:6px" /></div>
                <div style="height:8px"></div>
                <div class="small">Gain <input id="gain" type="range" min="0.5" max="2.0" step="0.01" value="1.0" /></div>
                <div style="height:8px"></div>
                <div class="small">Reverb <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.0" /></div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <audio id="player" crossorigin="anonymous" src="08.Hoomaan & Arown & Young Sudden - Jenaaze (128).mp3" preload="auto"></audio>

<script>
/* ============
   آماده‌سازی Web Audio و ویژوالایزر
   ============
*/
const player = document.getElementById('player');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const downloadBtn = document.getElementById('downloadBtn');
const viz = document.getElementById('viz');
const ctx = viz.getContext('2d');
const sensitivityEl = document.getElementById('sensitivity');
const bassBoostEl = document.getElementById('bassBoost');
const gainEl = document.getElementById('gain');
const reverbEl = document.getElementById('reverb');
const volLabel = document.getElementById('volLabel');
const lyricsEl = document.getElementById('lyrics');
const pasteLyricsBtn = document.getElementById('pasteLyrics');
const openSourceBtn = document.getElementById('openSource');
const cover = document.getElementById('cover');
const coverRef = document.getElementById('coverRef');
const titleEl = document.getElementById('title');

let audioCtx, analyser, source, gainNode, convolver;
let dataArray, freqArray;
let raf = null;

/* تنظیم اندازه canvas برای DPR */
function resize() {
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = viz.getBoundingClientRect();
  viz.width = Math.round(rect.width * dpr);
  viz.height = Math.round(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resize);
resize();

/* ساخت گراف صوتی */
function setupAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.85;

  gainNode = audioCtx.createGain();
  convolver = audioCtx.createConvolver();

  source = audioCtx.createMediaElementSource(player);
  source.connect(gainNode);
  gainNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  freqArray = new Uint8Array(bufferLength);
}

/* رسم ویژوالایزر پیشرفته */
function draw(){
  if (!analyser) return;
  raf = requestAnimationFrame(draw);
  analyser.getByteTimeDomainData(dataArray);
  analyser.getByteFrequencyData(freqArray);

  const w = viz.clientWidth;
  const h = viz.clientHeight;
  ctx.clearRect(0,0,w,h);

  // بک‌گراند نرم
  const g = ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0,'rgba(6,8,12,0.45)');
  g.addColorStop(1,'rgba(6,8,12,0.1)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  // موج زمان-دامنه
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(24,176,255,0.95)';
  ctx.beginPath();
  const slice = w / dataArray.length;
  let x = 0;
  for (let i=0;i<dataArray.length;i++){
    const v = dataArray[i]/128.0;
    const y = v * h/2;
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
    x += slice;
  }
  ctx.stroke();

  // بارهای فرکانسی با گرادینت
  const barCount = Math.min(64, Math.floor(w/6));
  const gap = Math.max(2, Math.floor(w/(barCount*20)));
  const barW = (w - gap*(barCount-1)) / barCount;
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,'rgba(155,89,255,0.95)');
  grad.addColorStop(0.5,'rgba(24,176,255,0.9)');
  grad.addColorStop(1,'rgba(24,176,255,0.14)');

  for (let i=0;i<barCount;i++){
    const idx = Math.floor(i * freqArray.length / barCount);
    const v = freqArray[idx] / 255;
    const barH = Math.max(2, v * h * 0.85);
    const bx = i * (barW + gap);
    const by = h - barH;
    ctx.fillStyle = grad;
    ctx.fillRect(bx,by,barW,barH);
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.fillRect(bx,by,barW, Math.min(6,barH));
  }

  // glow based on bass
  const lowCount = Math.max(4, Math.floor(freqArray.length * 0.06));
  let lowSum = 0;
  for (let i=0;i<lowCount;i++) lowSum += freqArray[i];
  const lowAvg = lowSum / lowCount;
  const r = Math.min(h, (lowAvg/255) * h * 1.6);
  const centerGrad = ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,r);
  centerGrad.addColorStop(0,'rgba(155,89,255,0.12)');
  centerGrad.addColorStop(1,'rgba(24,176,255,0)');
  ctx.fillStyle = centerGrad;
  ctx.fillRect(0,0,w,h);
}

/* پالس نور روی کاور و دکمه به جای لرزش */
let pulseAnim = null;
function startPulse(){
  if (!analyser) return;
  const el = cover;
  if (pulseAnim) cancelAnimationFrame(pulseAnim);
  function tick(){
    analyser.getByteFrequencyData(freqArray);
    // تمرکز روی باند پایین
    const lowCount = Math.max(4, Math.floor(freqArray.length * 0.06));
    let lowSum = 0;
    for (let i=0;i<lowCount;i++) lowSum += freqArray[i];
    const lowAvg = lowSum / lowCount;
    const intensity = Math.min(1.2, (lowAvg / 120)); // 0..1.2
    const scale = 1 + intensity * 0.02;
    const glow = 0.06 + intensity * 0.18;
    el.style.transform = `scale(${scale}) translateZ(8px)`;
    coverRef.style.opacity = glow;
    // دکمه پخش نورانی شود
    if (intensity > 0.12) playBtn.style.boxShadow = '0 20px 60px rgba(24,176,255,0.14)';
    else playBtn.style.boxShadow = '0 12px 40px rgba(24,176,255,0.06)';
    pulseAnim = requestAnimationFrame(tick);
  }
  pulseAnim = requestAnimationFrame(tick);
}
function stopPulse(){
  if (pulseAnim) cancelAnimationFrame(pulseAnim);
  cover.style.transform = '';
  coverRef.style.opacity = '';
  playBtn.style.boxShadow = '';
}

/* کنترل پخش و اتصالات */
playBtn.addEventListener('click', async ()=>{
  try{
    setupAudio();
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    await player.play();
    playBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');
    draw(); startPulse();
  }catch(e){ console.warn('play failed', e) }
});
pauseBtn.addEventListener('click', ()=>{
  player.pause();
  pauseBtn.classList.add('hidden'); playBtn.classList.remove('hidden');
  if (raf) cancelAnimationFrame(raf);
  stopPulse();
});

/* دانلود */
downloadBtn.addEventListener('click', ()=>{
  const a = document.createElement('a');
  a.href = encodeURI(player.src);
  a.download = player.src.split('/').pop();
  document.body.appendChild(a); a.click(); a.remove();
});

/* تنظیمات صوتی ساده */
gainEl.addEventListener('input', ()=>{ if (gainNode) gainNode.gain.value = parseFloat(gainEl.value); });
bassBoostEl.addEventListener('change', ()=>{ if (!gainNode) return; if (bassBoostEl.checked) gainNode.gain.setValueAtTime(1.4,audioCtx.currentTime); else gainNode.gain.setValueAtTime(parseFloat(gainEl.value),audioCtx.currentTime);});

/* راه‌اندازی nodes */
function setupAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.85;
  gainNode = audioCtx.createGain();
  source = audioCtx.createMediaElementSource(player);
  source.connect(gainNode);
  gainNode.connect(analyser);
  analyser.connect(audioCtx.destination);
  const bufferLength = analyser.frequencyBinCount;
  dataArray = new Uint8Array(bufferLength);
  freqArray = new Uint8Array(bufferLength);
}

/* انطباق حجم چراغ بازتاب کاور با اندازه تصویر */
function syncCoverRef(){
  try{
    const rect = cover.getBoundingClientRect();
    coverRef.style.height = Math.max(40, rect.height * 0.16) + 'px';
    coverRef.style.left = rect.left + 'px';
    coverRef.style.width = rect.width + 'px';
    coverRef.style.top = (rect.bottom - (rect.height * 0.08)) + 'px';
    coverRef.style.backgroundImage = `url('${cover.src}')`;
  }catch(e){}
}
window.addEventListener('resize', syncCoverRef);
cover.addEventListener('load', syncCoverRef);
setTimeout(syncCoverRef,800);

/* بارگذاری اولیه */
window.addEventListener('load', async ()=>{
  resize();
  try{
    setupAudio();
    // تلاش autoplay (ممکن است بلاک شود)
    await player.play();
    playBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden');
    draw(); startPulse();
  }catch(e){
    // اوتوپلی ممکن است نیاز به تعامل داشته باشد
    console.log('autoplay blocked or user gesture required');
  }
  volLabel.textContent = `${Math.round(player.volume*100)}%`;
});

/* paste lyrics: اجازه بده کاربر متن را پیست کند */
pasteLyricsBtn.addEventListener('click', async ()=>{
  try{
    const text = await navigator.clipboard.readText();
    if (!text) return alert('متنی در کلیپ‌بورد یافت نشد. متن را کپی کن و دوباره امتحان کن.');
    // ساده: هر خط را در یک div جدا می‌کنیم
    lyricsEl.innerHTML = '';
    text.split(/\r?\n/).forEach(ln=>{
      const d = document.createElement('div'); d.className='line'; d.textContent = ln || ' '; lyricsEl.appendChild(d);
    });
    alert('متن جایگذاری شد. اگر متن کامل نیست، از منبع رسمی آن را دریافت کن.');
  }catch(e){
    alert('خطا در دسترسی به کلیپ‌بورد. متن را دستی درون کادر پیست کن.');
  }
});

/* open source: نشان دادن لینک‌های پیشنهادی برای مشاهده متن (منابع پیدا شده) */
// منابع پیشنهادی: Mustext و Genius (باز کردن در تب جدید)
openSourceBtn.addEventListener('click', ()=>{
  // لینک‌ها را باز کن (در صورت نیاز یکی را انتخاب کن)
  const choices = [
    {name:'Mustext (متن)', url:'https://mustext.net/%D9%85%D8%AA%D9%86-%D8%A2%D9%87%D9%86%DA%AF-%D8%AC%D9%86%D8%A7%D8%B2%D9%87-%D9%87%D9%88%D9%85%D8%A7%D9%86-%D8%A2%D8%B1%D9%88%D9%86-%D9%88-%DB%8C%D8%A7%D9%86%DA%AF-%D8%B5%D8%A7%D062%AF%D9%86/'},
    {name:'Genius (English/lyrics)', url:'https://genius.com/Arman-miladi-jenaaze-lyrics'}
  ];
  // باز کردن اولی در تب جدید
  window.open(choices[0].url, '_blank');
});

/* جلوگیری از transform پیش‌فرض در مرورگر موبایل روی tap */
document.body.addEventListener('touchstart', ()=>{}, {passive:true});
</script>
</body>
</html>
